# 医疗手套控制与采集平台

## 1. 项目概述

本项目是一个基于Python的桌面应用程序，用于控制医疗康复手套硬件并实时采集、显示和存储其返回的肌电（EMG）信号数据。应用分为两个主要模块：**硬件控制端** (`kongzhi.py`) 和 **数据采集与分析端** (`caiji.py`)。

- **控制端**: 提供了一个简单直观的界面，用于连接硬件、设置不同的康复训练模式（如热身、肌力训练）、调整参数（如速度、时长）以及进行EMG信号校准。
- **采集端**: 提供了专业的多通道数据显示界面，能够实时绘制多达16个通道的EMG信号波形，支持数据暂停、通道显隐、数据保存为CSV格式，并带有语音提示功能以指导用户完成特定的训练流程。

## 2. 架构设计

本应用采用现代桌面应用设计模式，确保了UI的流畅性和数据处理的高效性。

- **模块化设计**: 项目在逻辑和功能上被清晰地划分为`控制模块`和`采集模块`。两个模块作为独立界面，用户可以从控制端切换至采集端，实现了关注点分离。

- **多线程模型**: 这是本应用的核心架构。通过将不同任务分配给独立线程，避免了耗时操作（如网络通信、数据处理）阻塞图形用户界面（GUI），保证了出色的用户体验。
  - **主线程**: 负责运行Tkinter事件循环，响应用户交互。
  - **网络接收线程**: 专门负责从socket连接中读取数据，并将原始数据包放入一个安全的队列中。
  - **数据处理线程**: 作为消费者，从队列中取出数据包，进行解析、计算，并准备用于绘图和存储。
  - **语音播报/流程控制线程**: 异步处理语音提示和实验流程控制，不影响主流程。

- **生产者-消费者模式**: 网络线程作为“生产者”持续不断地生成数据，数据处理线程作为“消费者”处理这些数据。`queue.Queue` 在它们之间扮演了关键的缓冲角色，有效地解耦了数据接收和处理过程。

- **模型-视图-控制器 (MVC) 思想**:
  - **模型 (Model)**: 肌电数据本身、设备状态、数据解析与存储逻辑。
  - **视图 (View)**: 由 `tkinter` 和 `matplotlib` 构建的图形界面。
  - **控制器 (Controller)**: 响应用户操作的各类函数，它们调用模型来更新数据或通过socket向硬件发送指令。

## 3. 模块说明

### `kongzhi.py` - 控制端

控制端是应用的入口，主要负责人机交互和向硬件发送高级指令。

- **功能列表**:
  - **WiFi连接**: 设置硬件的IP地址和端口，并建立TCP连接。
  - **热身模式**: 控制硬件以设定的速度进行连续运动。
  - **肌力训练模式**: 提供多种预设模式（模式1, 2, 3），并可设定训练时长，界面上提供倒计时功能。
  - **EMG校准**: 发送开始和结束指令，用于校准肌电信号的基线或阈值。
  - **简易波形显示**: 提供一个单通道的EMG波形图，用于快速预览信号状态。
  - **界面切换**: 提供一个按钮，可以关闭当前界面并启动功能更强大的`采集与分析端`。

### `caiji.py` - 采集与分析端

采集端是专业的数据处理中心，专注于数据的接收、解析、可视化和存储。

- **功能列表**:
  - **多通道实时绘图**: 使用`matplotlib`高效绘制多达16个通道的实时波形数据，支持缩放、暂停和恢复。
  - **通道可见性控制**: 用户可以通过复选框动态显示或隐藏任意通道的波形，便于观察特定通道。
  - **数据持久化**: 将采集到的多通道数据以`CSV`格式批量写入本地文件，文件名包含时间戳，便于后续分析。采用批量写入策略以优化I/O性能。
  - **可配置性**: 启动时从`config.txt`文件加载配置，包括通道数、Y轴范围、IP/端口、实验参数等，无需修改代码即可适配不同场景。
  - **语音播报**: 集成Windows TTS引擎，可根据预设的实验流程（如收缩-放松循环）提供语音指导。
  - **性能监控**: 界面上实时显示数据包接收频率（Hz），用于判断通信质量。

## 4. 如何运行

### 依赖安装

请确保您的Python环境中安装了以下库：


一键安装(建议在虚拟环境下):
- 创建虚拟环境(已创建)
```
python -m venv venv
```
- 激活虚拟环境
```
venv\Scripts\activate
```
- 安装依赖
```
pip install -r requirements.txt
```

### 启动应用

直接运行`kongzhi.py`文件即可启动应用程序的控制端界面。

```bash
python kongzhi.py
```

## 5. 配置文件说明 (`config.txt`)

`caiji.py`模块的行为由`config.txt`文件控制，这使得应用非常灵活。文件包含以下部分：

- **[CHANNELS]**:
  - `num_channels`: 定义了硬件发送的通道数量，例如 `16`。
- **[YAXIS_MAIN]**:
  - `y_top`, `y_bottom`: 设置主绘图区域的Y轴上下限。
- **[EXPERIMENT]**:
  - `cycle_total`: 训练循环的总次数。
  - `contraction_time`: 每次收缩阶段的持续时间（秒）。
  - `relaxation_time`: 每次放松阶段的持续时间（秒）。
  - `voice_broadcast`: 是否启用语音播报 (`true` 或 `false`)。
- **[CONNECTION]**:
  - `ip_address`, `port`: 硬件的IP地址和端口号。

## 6. 通信协议

### 控制指令 (PC -> 硬件)

PC通过TCP连接向硬件发送简单的ASCII字符串指令。

- `S<speed>`: 设置热身速度，例如 `S1500`。
- `mode1`, `mode2`, `mode3`: 切换到对应的肌力训练模式。
- `pause`: 暂停当前运动。
- `EMG_Cali_S`: 开始EMG校准。
- `EMG_Cali_E`: 结束EMG校准。

### 数据包格式 (硬件 -> PC)

硬件向PC发送二进制数据流。`caiji.py`模块负责解析这种格式。

- **帧头**: 每个有效数据块都以 `0xAA` 字节开始。
- **数据结构**: 一个完整的数据包内包含5组连续的采样数据，每组采样数据包含`N`个通道的浮点数值（`N`由`config.txt`中的`num_channels`定义）。
- **解析方式**: 程序首先在数据流中定位`0xAA`，然后读取固定长度的字节块，并使用`struct.unpack`按`N`个浮点数的格式进行解码。